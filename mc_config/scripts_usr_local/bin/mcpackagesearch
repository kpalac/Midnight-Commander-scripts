#!/bin/bash



#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program.  If not, see <http://www.gnu.org/licenses/>.

#  Author: Karol Pa≈Çac (lolko), palac.karol@gmail.com



# This is a script to search packages for Midnight Commander



. /usr/local/lib/mcCLIinterface







PHRASE="$@"


SOPTION="0"
SPAGE="0"
SBASE="0"

declare -a PACKAGE



TF_Redraw ()
{
    
    WIDTH="$(/usr/bin/tput cols)"
    HEIGHT="$(/usr/bin/tput lines)"

    PUTY="$(( ($HEIGHT / 2) - 10))"
    PUTX="$(( ($WIDTH / 2) - 45))"


    clear

    printfxy $PUTY $PUTX	"\e[1;$TEXTCOL				Search Packages \e[0;$TEXTCOL"
    printfxy $(($PUTY+2)) $PUTX	"	Search phrase \e[1;$TEXTCOL $PHRASE \e[0;$TEXTCOL"
    
    I="1"
    for I in 1 2 3 4 5 6 7 8 9 0; do

	J=$(($I+1))
	[ "$J" = "10" ] && J=0

	printfxy $(($PUTY+4+$I)) $PUTX	"	[$J] ${PACKAGE[$((SBASE+I))]}"

    done

    printfxy $(($PUTY+15)) $PUTX	"\e[1;$LINECOL	[1-9,0] Package Information and Homepage	[Shift+1-9,0]  Install Package"
    printfxy $(($PUTY+16)) $PUTX	"	[<,>] PgUp, PgDn"
    printfxy $(($PUTY+18)) $PUTX	"\e[1;$LINECOL	[u] Update package database"

    printfxy $(($PUTY+20)) $PUTX	"	[q] Cancel\e[0;$TEXTCOL"
} #Redraw








TF_GetData ()
{
    mapfile -t PACKAGE < <(/usr/bin/apt-cache search "$PHRASE" )
} #GetData





TF_GetData
TF_Redraw




TF_GetInfo () {

    TV_SBASE="$1"
    shift
    TV_NR="$1"

    if [[ "$TV_NR" = "0" ]]; then
	TV_NR="9"
    else
	TV_NR="$(($TV_NR-1))"
    fi

	URL="$(/usr/bin/apt-cache show "$(TF_Cut ' ' 1 "${PACKAGE[$(($TV_SBASE+$TV_NR))]}")" | /bin/grep '^Homepage ' | /usr/bin/cut -d' ' -f2-)"
	if [ "$URL" != "" ] && [ "$(/usr/bin/whoami)" != "root" ]; then
	    xdg-open "$URL"
	fi
	/usr/bin/apt-cache show "$(TF_Cut ' ' 1 "${PACKAGE[$(($TV_SBASE+$TV_NR))]}")" | /usr/bin/less
	TF_Redraw
#"
} #TF_GetInfo




TF_DoInstall () {

    TV_SBASE="$1"
    shift
    TV_NR="$1"
    TV_NR="$(TF_NumDecap "$TV_NR")"

    if [[ "$TV_NR" = "0" ]]; then
	TV_NR="9"
    else
	TV_NR="$(($TV_NR-1))"
    fi

    clear
    /usr/bin/sudo /usr/bin/apt-get install "$(TF_Cut ' ' 1 "${PACKAGE[$(($TV_SBASE+$TV_NR))]}")"
    #"
    TF_GetData
    TF_Redraw

} #TF_DoInstall





#Main execution loop

while [[ "$CH" != ['q''Q'] ]]; do

    if [ "$HEIGHT" != "$(/usr/bin/tput lines)" ] || [ "$WIDTH" != "$(/usr/bin/tput cols)" ]; then
	TF_Redraw
    fi

    read -n 1 -t 1 -s CH

    if [ "$CH" = "$(echo -en "\033")" ];then
		CH3="$CH2"
		CH2="$CH"
	    continue
    elif	 [ "$k2" = "$(echo -en "\033")" -a "$k1" = "[" ];then
		CH3="$CH2"
		CH2="$CH"
	    continue
    fi

known_esc_seq=1
last_three_keys="$CH3$CH2$CH"


case "$last_three_keys" in
    "$up")
	if [ "$SPAGE" != "0" ]; then
		SPAGE="$(($SPAGE-1))"
		SBASE="$(($SPAGE*10))"
    		TF_Redraw
	fi
     ;;
   "$down")
    	if [ "${PACKAGE[$(((SPAGE+1)*10))]}" != "" ]; then
		SPAGE="$(($SPAGE+1))"
		SBASE="$(($SPAGE*10))"
		TF_Redraw
	fi
    ;;
   "$left")
	if [ "$SPAGE" != "0" ]; then
		SPAGE="$(($SPAGE-1))"
		SBASE="$(($SPAGE*10))"
    		TF_Redraw
	fi
    ;;
   "$right")
	if [ "${PACKAGE[$(((SPAGE+1)*10))]}" != "" ]; then
		SPAGE="$(($SPAGE+1))"
		SBASE="$(($SPAGE*10))"
		TF_Redraw
	fi
    ;;
    "$pgup")
	if [ "$SPAGE" != "0" ]; then
		SPAGE="$(($SPAGE-1))"
		SBASE="$(($SPAGE*10))"
    		TF_Redraw
	fi
    ;;
    "$pgdn")
	if [ "${PACKAGE[$(((SPAGE+1)*10))]}" != "" ]; then
		SPAGE="$(($SPAGE+1))"
		SBASE="$(($SPAGE*10))"
		TF_Redraw
	fi
    ;;
    "$home")
	SPAGE="0"
	SBASE="0"
	TF_Redraw
    ;;

    *)
	known_esc_seq=0
    ;;

esac

if [ $known_esc_seq -eq 0 ];then

    case "$CH" in
		['1''2''3''4''5''6''7''8''9''0'])
		    TF_GetInfo "$SBASE" "$CH"
		;;

		['!''@''#''$''%''^''&''*''('')'])
		    TF_DoInstall "$SBASE" "$CH"
		;;

		['u''U'])
		    clear
		    /usr/bin/sudo /usr/bin/apt-get update
		    TF_GetData
		    CH=""
		    TF_Redraw
		;;

		['>''.'])
		    if [ "${PACKAGE[$(((SPAGE+1)*10))]}" != "" ]; then
			SPAGE="$(($SPAGE+1))"
			SBASE="$(($SPAGE*10))"
			TF_Redraw
		    fi
		    ;;
		['<'','])
		    if [ "$SPAGE" != "0" ]; then
			SPAGE="$(($SPAGE-1))"
			SBASE="$(($SPAGE*10))"
			TF_Redraw
		    fi
		    ;;
		'*')
		    if [ "$HEIGHT" != "$(/usr/bin/tput lines)" ] || [ "$WIDTH" != "$(/usr/bin/tput cols)" ]; then
			TF_Redraw
		    fi
		;;
    esac
fi

        CH3="$CH2"
	CH2="$CH"


done


TF_OnExit 0